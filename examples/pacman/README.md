# Pac-Man

## 🍒 Layouts
The layouts are defined in the [layouts](layouts/) directory in text format with the extension `.lay`. The first line of the file contains the dimensions of the layout and the number of ghosts. The layout is a rectangular grid of characters. The characters have the following meaning:

- ` ` : empty space
- `%` : wall
- `.` : food

The initial positions of the agents (Pac-Man and the ghosts) are written separated by spaces. The positions are written as `row column` pairs (`0 0` would be the top-leftmost cell). The positions of the ghosts are followed by their initial directions. The directions are encoded as follows:

- `0` : no direction
- `1` : east
- `2` : west
- `3` : north
- `4` : south

See [halfClassic.lay](layouts/halfClassic.lay) as an example.

```text
9 21 4                  # dimensions of the layout and number of ghosts
%%%%%%%%%%%%%%%%%%%%%   ----
% ...     %         %      |
% %%% %%% % %%% %%% %      |
% ..%...     ...%   %      |
%%%.%.%.%%%%%.%.% %%%      |- design of the layout
%..   %   %   %     %      |
%.%%% %%%.% %%% %%% %      |
%       ..       ...%      |
%%%%%%%%%%%%%%%%%%%%%   ----
7 10 0                  # pacman's position
3 8 1                   # ghost 1 at position (3, 8) moving east
3 9 4                   # ghost 2 at position (3, 9) moving south
3 10 2                  # ghost 3 at position (3, 10) moving west
3 11 1                  # ghost 4 at position (3, 11) moving east
```

## 🍒 Creating prism files from layouts
The [pacmanPrism.py](pacmanPrism.py) script can be used to create prism files from the layouts. The script takes the path to the layout file as an argument. The output is written in a file named `pacman.nm`.

```bash
python pacmanPrism.py layouts/halfClassic.lay
```

The prism file contains the following modules:
- `arbiter` : the arbiter module makes sure that the agents move one-by-one
- `pacman` : the module for Pac-Man
- `ghost0` to `ghost{n-1}`: the module for the ghosts
- `check` : the module that updates the food and the score

The arbiter takes one step to check if the game has been won or lost already and then forces the agents to move one by one. Then it updates the food. Thus one step in the game is actually `number of ghosts + 3` steps in the MDP we define.


## 🍒 Running MCTS
The configuration file [pacman.yml](pacman.yml) contains the parameters of MCTS. The advice classes and the print function are defined in the file [pacmanAdvice.py](pacmanAdvice.py).

To run the example, use the following command from the root directory of the project:

```bash
python3 main.py examples/pacman/pacman.yml
```

## 🍒 Advice classes

> 📝 The parameters for the advice are hard-coded in the code for now. I need to find a way to have them in the YAML file.

The advice classes are defined in the file [pacmanAdvice.py](pacmanAdvice.py). The file contains the following classes:

### Storm-based advice
The `MDPStormActionAdvice` class implements the action-based advice using Storm. For a state $s$ and action $a$ pair, it computes the maximum probability of staying safe for $H$ steps after taking action $a$ in state $s$:
$$P(s,a) = \sup_{\sigma\mid\sigma(s)=a} \Pr_{\sigma}(G^{\leq H}\neg loss)$$
where $H$ is a parameter of the class. The advice returns the action with the highest probability. 

the probability of reaching a state with a score of at least 100. The advice is given by the action with the highest probability. The advice is computed using the `mdpStormAdvice` method.

### Neural network-based advice
We represent a state in the MDP as a tensor of shape `(height, width, 7)`. The layers represent the following:
- layer 0 : walls
- layer 1 : postion of the Pacman
- layer 2 : position of the ghosts going towards east
- layer 3 : position of the ghosts going towards west
- layer 4 : position of the ghosts going towards north
- layer 5 : position of the ghosts going towards south
- layer 6 : food

The `MDPNNActionAdvice` class implements action-based advice using a neural network. The folder [models](models) contains the trained neural networks (in `h5` format readable by `tensorflow.keras`) for the layout [halfClassic.lay](layouts/halfClassic.lay).

There are two neural networks in the folder:
- `all.h5` : it takes all the layers as input and is trained from data generated by MCTS
- `safety.h5` : it takes first 6 layers as the input and is trained from data generated from storm-based advice with depth $H = 8$

> 📝 The neural networks support tensors in `NHWC` format. A tensor in `NCWH` format can be converted to `NHWC` format by `tensor = tf.transpose(tensor, [0, 2, 3, 1])`



